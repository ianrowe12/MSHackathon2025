<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Presentation Coach - Enhanced Feedback System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            border-color: #667eea;
            outline: none;
        }

        .analyze-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
        }

        .analysis-tabs {
            display: flex;
            margin-bottom: 25px;
            background: #fff;
            border-radius: 12px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            color: #666;
        }

        .tab-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-1px);
        }

        .tab-btn:hover:not(.active) {
            background: #f8f9fa;
            color: #333;
        }

        .analysis-tab {
            display: none;
        }

        .analysis-tab.active {
            display: block;
        }

        .input-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
            transition: border-color 0.3s;
        }

        .input-group textarea:focus {
            border-color: #667eea;
            outline: none;
        }

        .pattern-item, .structure-item, .combined-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .pattern-label, .structure-label {
            font-weight: 600;
            color: #555;
        }

        .pattern-value, .structure-value {
            font-weight: 500;
            color: #667eea;
        }

        .combined-summary {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .combined-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .metric-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }

        .content-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }

        .content-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            display: none;
        }

        .insights-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .insights-header {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .archetype-badge {
            display: inline-block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .development-stage {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }

        .stage-foundational {
            background: #ffeaa7;
            color: #d63031;
        }

        .stage-intermediate {
            background: #a8e6cf;
            color: #00b894;
        }

        .stage-advanced {
            background: #dda0dd;
            color: #6c5ce7;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .metric-label {
            font-weight: 600;
            color: #555;
        }

        .metric-value {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1em;
        }

        .score-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 1s ease-in-out;
        }

        .emotional-arc {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
        }

        .arc-consistently-strong {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .arc-building-confidence {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .arc-fading-energy {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .recommendation-card {
            border-left: 4px solid #667eea;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .rec-priority-critical {
            border-left-color: #dc3545;
        }

        .rec-priority-high {
            border-left-color: #fd7e14;
        }

        .rec-priority-medium {
            border-left-color: #ffc107;
        }

        .rec-priority-low {
            border-left-color: #28a745;
        }

        .rec-priority-celebration {
            border-left-color: #6f42c1;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .rec-category {
            font-size: 0.9em;
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .rec-suggestion {
            font-size: 1em;
            line-height: 1.6;
            margin-bottom: 12px;
            color: #333;
        }

        .rec-next-steps {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .rec-next-steps h4 {
            font-size: 0.9em;
            color: #667eea;
            margin-bottom: 8px;
        }

        .rec-next-steps ul {
            margin-left: 20px;
        }

        .rec-next-steps li {
            margin-bottom: 4px;
            font-size: 0.9em;
        }

        .timeline-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .timeline-timestamp {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            min-width: 70px;
            text-align: center;
        }

        .timeline-emotion {
            margin-left: 15px;
            font-weight: 600;
            flex: 1;
        }

        .timeline-confidence {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .ai-chat-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }

        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
        }

        .message.user {
            background: #e3f2fd;
            margin-left: 20px;
        }

        .message.assistant {
            background: #f3e5f5;
            margin-right: 20px;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #667eea;
            font-weight: 600;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 AI Presentation Coach</h1>
            <p>Advanced emotion analysis and personalized coaching for presentation excellence</p>
        </div>

        <div class="content">
            <!-- Input Section -->
            <div class="input-section">
                <!-- Analysis Type Tabs -->
                <div class="analysis-tabs">
                    <button class="tab-btn active" onclick="switchAnalysisType('video')">🎥 Video Analysis</button>
                    <button class="tab-btn" onclick="switchAnalysisType('transcript')">📝 Transcript Analysis</button>
                    <button class="tab-btn" onclick="switchAnalysisType('combined')">🔗 Combined Analysis</button>
                </div>

                <!-- Video Analysis Tab -->
                <div id="video-analysis" class="analysis-tab active">
                    <div class="input-group">
                        <label for="videoUrl">📹 Video URL</label>
                        <input type="url" id="videoUrl" placeholder="https://example.com/your-presentation-video.mp4" />
                    </div>
                    <button id="analyzeVideoBtn" class="analyze-btn">
                        🚀 Analyze Video Presentation
                    </button>
                </div>

                <!-- Transcript Analysis Tab -->
                <div id="transcript-analysis" class="analysis-tab">
                    <div class="input-group">
                        <label for="transcriptText">📝 Presentation Transcript</label>
                        <textarea id="transcriptText" placeholder="Paste your presentation transcript here..." rows="6"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="transcriptFile">📄 Or Upload Transcript File</label>
                        <input type="file" id="transcriptFile" accept=".vtt,.srt,.txt" />
                    </div>
                    <button id="analyzeTranscriptBtn" class="analyze-btn">
                        🎤 Analyze Speech & Delivery
                    </button>
                </div>

                <!-- Combined Analysis Tab -->
                <div id="combined-analysis" class="analysis-tab">
                    <div class="input-group">
                        <label for="combinedVideoUrl">📹 Video URL</label>
                        <input type="url" id="combinedVideoUrl" placeholder="https://example.com/your-presentation-video.mp4" />
                    </div>
                    <div class="input-group">
                        <label for="combinedTranscriptText">📝 Presentation Transcript</label>
                        <textarea id="combinedTranscriptText" placeholder="Paste your presentation transcript here..." rows="4"></textarea>
                    </div>
                    <button id="analyzeCombinedBtn" class="analyze-btn">
                        🔥 Full Presentation Analysis
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="results-section">
                <!-- Speaker Profile -->
                <div class="insights-card">
                    <div class="insights-header">
                        👤 Your Speaker Profile
                    </div>
                    <div id="speakerProfile"></div>
                </div>

                <!-- Key Metrics -->
                <div class="insights-card">
                    <div class="insights-header">
                        📊 Performance Metrics
                    </div>
                    <div id="keyMetrics"></div>
                </div>

                <!-- Emotional Journey -->
                <div class="insights-card">
                    <div class="insights-header">
                        🎭 Emotional Journey
                    </div>
                    <div id="emotionalJourney"></div>
                </div>

                <!-- Personalized Recommendations -->
                <div class="insights-card">
                    <div class="insights-header">
                        💡 Personalized Coaching Recommendations
                    </div>
                    <div id="recommendations"></div>
                </div>

                <!-- AI Chat Section -->
                <div class="ai-chat-section">
                    <div class="insights-header">
                        🤖 AI Presentation Coach Chat
                    </div>
                    <div id="chatMessages" class="chat-messages">
                        <div class="message assistant">
                            <strong>AI Coach:</strong> Hi! I've analyzed your presentation and I'm ready to provide personalized feedback and answer any questions you have about improving your presentation skills. What would you like to know?
                        </div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="chatInput" placeholder="Ask me anything about your presentation..." />
                        <button id="sendChatBtn" class="analyze-btn" style="width: auto; margin-top: 10px;">Send</button>
                    </div>
                </div>

                <!-- Transcript Analysis Results -->
                <div id="transcriptResults" class="insights-card" style="display: none;">
                    <div class="insights-header">
                        🎤 Speech & Delivery Analysis
                    </div>
                    
                    <!-- Speech Quality Metrics -->
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-title">🎯 Overall Speech Quality</div>
                            <div class="metric-value" id="speechQuality">--</div>
                            <div class="score-bar">
                                <div class="score-fill" id="speechQualityBar"></div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-title">⚡ Speaking Pace</div>
                            <div class="metric-value" id="speakingPace">-- WPM</div>
                            <div class="score-bar">
                                <div class="score-fill" id="speakingPaceBar"></div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-title">🎵 Tone Variety</div>
                            <div class="metric-value" id="toneVariety">--</div>
                            <div class="score-bar">
                                <div class="score-fill" id="toneVarietyBar"></div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-title">📊 Clarity Score</div>
                            <div class="metric-value" id="clarityScore">--</div>
                            <div class="score-bar">
                                <div class="score-fill" id="clarityScoreBar"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Speech Patterns -->
                    <div class="content-grid">
                        <div class="content-section">
                            <h4>💬 Speech Patterns</h4>
                            <div id="speechPatterns">
                                <div class="pattern-item">
                                    <span class="pattern-label">Filler Words:</span>
                                    <span class="pattern-value" id="fillerWords">--</span>
                                </div>
                                <div class="pattern-item">
                                    <span class="pattern-label">Pauses:</span>
                                    <span class="pattern-value" id="pausePattern">--</span>
                                </div>
                                <div class="pattern-item">
                                    <span class="pattern-label">Repetitions:</span>
                                    <span class="pattern-value" id="repetitions">--</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="content-section">
                            <h4>📈 Content Structure</h4>
                            <div id="contentStructure">
                                <div class="structure-item">
                                    <span class="structure-label">Transitions:</span>
                                    <span class="structure-value" id="transitions">--</span>
                                </div>
                                <div class="structure-item">
                                    <span class="structure-label">Key Points:</span>
                                    <span class="structure-value" id="keyPoints">--</span>
                                </div>
                                <div class="structure-item">
                                    <span class="structure-label">Conclusion:</span>
                                    <span class="structure-value" id="conclusion">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Speech Recommendations -->
                    <div class="recommendations-grid" id="speechRecommendations">
                        <!-- Speech recommendations will be populated here -->
                    </div>
                </div>

                <!-- Combined Analysis Results -->
                <div id="combinedResults" class="insights-card" style="display: none;">
                    <div class="insights-header">
                        🔥 Comprehensive Analysis
                    </div>
                    <div class="combined-summary">
                        <h4>📊 Multi-Modal Assessment</h4>
                        <p>This analysis combines both visual emotion tracking and speech delivery analysis to provide a complete picture of your presentation performance.</p>
                        
                        <div class="combined-metrics">
                            <div class="combined-metric">
                                <span class="metric-label">Visual Engagement:</span>
                                <span class="metric-value" id="combinedVisual">--</span>
                            </div>
                            <div class="combined-metric">
                                <span class="metric-label">Speech Quality:</span>
                                <span class="metric-value" id="combinedSpeech">--</span>
                            </div>
                            <div class="combined-metric">
                                <span class="metric-label">Overall Score:</span>
                                <span class="metric-value" id="combinedOverall">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentInsights = null;
        let currentAnalysisType = 'video';
        const FUNCTION_ENDPOINT = 'https://your-function-app.azurewebsites.net/api/analyze_video';
        const TRANSCRIPT_ENDPOINT = 'https://your-function-app.azurewebsites.net/api/analyze_transcript'; // Part B endpoint
        const OPENAI_API_KEY = 'your-openai-api-key'; // Configure this

        // Event listeners for different analysis types
        document.getElementById('analyzeVideoBtn').addEventListener('click', analyzeVideo);
        document.getElementById('analyzeTranscriptBtn').addEventListener('click', analyzeTranscript);
        document.getElementById('analyzeCombinedBtn').addEventListener('click', analyzeCombined);
        document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // File upload handler
        document.getElementById('transcriptFile').addEventListener('change', handleFileUpload);

        function switchAnalysisType(type) {
            currentAnalysisType = type;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide analysis tabs
            document.querySelectorAll('.analysis-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(type + '-analysis').classList.add('active');
            
            // Hide all result sections
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('transcriptResults').style.display = 'none';
            document.getElementById('combinedResults').style.display = 'none';
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const text = await file.text();
                document.getElementById('transcriptText').value = text;
            }
        }

        async function analyzeVideo() {
            const videoUrl = document.getElementById('videoUrl').value;
            
            if (!videoUrl) {
                alert('Please enter a video URL');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeVideoBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<div class="loading"><div class="spinner"></div> Analyzing your presentation...</div>';

            try {
                // Call your Azure Function
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        video_url: videoUrl
                    })
                });

                if (!response.ok) {
                    throw new Error(`Analysis failed: ${response.statusText}`);
                }

                const insights = await response.json();
                currentInsights = insights;
                
                displayResults(insights);
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('transcriptResults').style.display = 'none';
                document.getElementById('combinedResults').style.display = 'none';
                
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Analysis failed. Please check your video URL and try again.');
                
                // Show demo results for testing
                displayDemoResults();
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '🚀 Analyze Video Presentation';
            }
        }

        async function analyzeTranscript() {
            const transcriptText = document.getElementById('transcriptText').value;
            
            if (!transcriptText.trim()) {
                alert('Please enter or upload a transcript');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeTranscriptBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<div class="loading"><div class="spinner"></div> Analyzing your speech...</div>';

            try {
                // Call Part B Azure Function for transcript analysis
                const response = await fetch('/api/analyze-transcript', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        transcript: transcriptText
                    })
                });

                if (!response.ok) {
                    throw new Error('Transcript analysis failed');
                }

                const insights = await response.json();
                currentInsights = insights;
                displayTranscriptResults(insights);
                document.getElementById('transcriptResults').style.display = 'block';
                document.getElementById('resultsSection').style.display = 'none';
                document.getElementById('combinedResults').style.display = 'none';

            } catch (error) {
                console.error('Error:', error);
                alert('Transcript analysis failed. Please try again.');
                // Show demo transcript results for testing
                displayDemoTranscriptResults();
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '🎤 Analyze Speech & Delivery';
            }
        }

        async function analyzeCombined() {
            const videoUrl = document.getElementById('combinedVideoUrl').value;
            const transcriptText = document.getElementById('combinedTranscriptText').value;
            
            if (!videoUrl || !transcriptText.trim()) {
                alert('Please provide both video URL and transcript');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeCombinedBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<div class="loading"><div class="spinner"></div> Running comprehensive analysis...</div>';

            try {
                // Run both analyses in parallel
                const [videoResponse, transcriptResponse] = await Promise.all([
                    fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ video_url: videoUrl })
                    }),
                    fetch('/api/analyze-transcript', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ transcript: transcriptText })
                    })
                ]);

                if (!videoResponse.ok || !transcriptResponse.ok) {
                    throw new Error('Combined analysis failed');
                }

                const videoInsights = await videoResponse.json();
                const transcriptInsights = await transcriptResponse.json();
                
                const combinedInsights = {
                    video: videoInsights,
                    transcript: transcriptInsights,
                    combined_score: calculateCombinedScore(videoInsights, transcriptInsights)
                };

                currentInsights = combinedInsights;
                displayResults(videoInsights); // Show video results
                displayTranscriptResults(transcriptInsights); // Show transcript results
                displayCombinedResults(combinedInsights); // Show combined summary
                
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('transcriptResults').style.display = 'block';
                document.getElementById('combinedResults').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                alert('Combined analysis failed. Please try again.');
                // Show demo results for testing
                displayDemoResults();
                displayDemoTranscriptResults();
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '🔥 Full Presentation Analysis';
            }
        }

        function displayResults(insights) {
            document.getElementById('resultsSection').style.display = 'block';
            
            displaySpeakerProfile(insights);
            displayKeyMetrics(insights);
            displayEmotionalJourney(insights);
            displayRecommendations(insights);
        }

        function displaySpeakerProfile(insights) {
            const coaching = insights.coaching_insights || {};
            const archetype = coaching.speaker_archetype || 'balanced_communicator';
            const stage = coaching.development_stage || 'intermediate';
            
            const archetypeNames = {
                'enthusiastic_connector': 'Enthusiastic Connector',
                'analytical_expert': 'Analytical Expert',
                'natural_leader': 'Natural Leader',
                'developing_speaker': 'Developing Speaker',
                'confident_professional': 'Confident Professional',
                'balanced_communicator': 'Balanced Communicator'
            };

            const html = `
                <div class="archetype-badge">${archetypeNames[archetype] || archetype}</div>
                <span class="development-stage stage-${stage}">${stage.toUpperCase()}</span>
                
                <div style="margin-top: 20px;">
                    <h4 style="color: #28a745; margin-bottom: 10px;">🌟 Your Strengths:</h4>
                    <ul style="margin-left: 20px;">
                        ${(coaching.communication_strengths || []).map(strength => `<li>${strength}</li>`).join('')}
                    </ul>
                </div>

                <div style="margin-top: 15px;">
                    <h4 style="color: #fd7e14; margin-bottom: 10px;">🚀 Growth Opportunities:</h4>
                    <ul style="margin-left: 20px;">
                        ${(coaching.growth_opportunities || []).map(opportunity => `<li>${opportunity}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            document.getElementById('speakerProfile').innerHTML = html;
        }

        function displayKeyMetrics(insights) {
            const presentation = insights.presentation_quality || {};
            const facial = insights.facial_analysis || {};
            const emotional = insights.visual_sentiment?.emotional_patterns || {};
            
            const html = `
                <div class="metric-row">
                    <span class="metric-label">🎯 Visual Engagement</span>
                    <span class="metric-value">${presentation.visual_engagement || 0}/100</span>
                </div>
                <div class="score-bar">
                    <div class="score-fill" style="width: ${presentation.visual_engagement || 0}%"></div>
                </div>

                <div class="metric-row">
                    <span class="metric-label">👀 Eye Contact Rating</span>
                    <span class="metric-value">${presentation.body_language?.eye_contact_rating || 0}/100</span>
                </div>
                <div class="score-bar">
                    <div class="score-fill" style="width: ${presentation.body_language?.eye_contact_rating || 0}%"></div>
                </div>

                <div class="metric-row">
                    <span class="metric-label">😊 Smile Percentage</span>
                    <span class="metric-value">${facial.facial_expressions?.smile_percentage || 0}%</span>
                </div>

                <div class="metric-row">
                    <span class="metric-label">🎭 Faces Detected</span>
                    <span class="metric-value">${facial.faces_detected || 0}</span>
                </div>

                <div class="emotional-arc arc-${emotional.emotional_arc?.replace('_', '-') || 'unknown'}">
                    📈 Emotional Arc: ${emotional.emotional_arc?.replace('_', ' ').toUpperCase() || 'ANALYZING...'}
                </div>
            `;
            
            document.getElementById('keyMetrics').innerHTML = html;
        }

        function displayEmotionalJourney(insights) {
            const timeline = insights.facial_analysis?.emotion_timeline || [];
            const patterns = insights.visual_sentiment?.emotional_patterns || {};
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 10px;">
                        <div style="font-size: 2em; color: #1976d2;">🚀</div>
                        <div style="font-weight: 600; margin-top: 5px;">Opening</div>
                        <div style="color: #666;">${Math.round((patterns.opening_confidence || 0) * 100)}% confidence</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f3e5f5; border-radius: 10px;">
                        <div style="font-size: 2em; color: #7b1fa2;">⚡</div>
                        <div style="font-weight: 600; margin-top: 5px;">Peak Energy</div>
                        <div style="color: #666;">${Math.round((patterns.mid_presentation_energy || 0) * 100)}% energy</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 10px;">
                        <div style="font-size: 2em; color: #388e3c;">🎯</div>
                        <div style="font-weight: 600; margin-top: 5px;">Closing Impact</div>
                        <div style="color: #666;">${Math.round((patterns.closing_impact || 0) * 100)}% impact</div>
                    </div>
                </div>
            `;

            if (timeline.length > 0) {
                html += `
                    <div class="timeline-container">
                        <h4 style="margin-bottom: 15px; color: #667eea;">📅 Emotion Timeline</h4>
                        ${timeline.slice(0, 5).map(moment => `
                            <div class="timeline-item">
                                <div class="timeline-timestamp">${moment.timestamp || 'N/A'}</div>
                                <div class="timeline-emotion">${moment.emotion || 'neutral'}</div>
                                <div class="timeline-confidence">${Math.round((moment.confidence || 0) * 100)}%</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            document.getElementById('emotionalJourney').innerHTML = html;
        }

        function displayRecommendations(insights) {
            const recommendations = insights.recommendations || [];
            
            const html = `
                <div class="recommendations-grid">
                    ${recommendations.map(rec => `
                        <div class="recommendation-card rec-priority-${rec.priority || 'medium'}">
                            <div class="rec-category">${rec.category || 'General'}</div>
                            <div class="rec-suggestion">${rec.suggestion || 'No suggestion available'}</div>
                            <div style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                                <strong>Impact:</strong> ${rec.score_impact || 'Positive improvement'}
                            </div>
                            ${rec.next_steps ? `
                                <div class="rec-next-steps">
                                    <h4>Next Steps:</h4>
                                    <ul>
                                        ${rec.next_steps.map(step => `<li>${step}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('recommendations').innerHTML = html;
        }

        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;

            // Add user message
            addChatMessage('user', message);
            chatInput.value = '';

            // Add thinking message
            const thinkingMsg = addChatMessage('assistant', 'Thinking...');

            try {
                const response = await generateAIResponse(message);
                thinkingMsg.innerHTML = `<strong>AI Coach:</strong> ${response}`;
            } catch (error) {
                thinkingMsg.innerHTML = `<strong>AI Coach:</strong> I'm sorry, I'm having trouble connecting right now. Let me give you some general advice based on your analysis...`;
            }
        }

        function addChatMessage(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = sender === 'user' ? `<strong>You:</strong> ${message}` : message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }

        async function generateAIResponse(userMessage) {
            if (!currentInsights) {
                return "Please analyze a video first so I can provide personalized feedback!";
            }

            // Create a rich context for the AI
            const coaching = currentInsights.coaching_insights || {};
            const archetype = coaching.speaker_archetype || 'balanced_communicator';
            const stage = coaching.development_stage || 'intermediate';
            const patterns = currentInsights.visual_sentiment?.emotional_patterns || {};
            const recommendations = currentInsights.recommendations || [];

            const systemPrompt = `You are an expert presentation coach. The user has just had their presentation analyzed with these insights:

Speaker Archetype: ${archetype}
Development Stage: ${stage}
Emotional Arc: ${patterns.emotional_arc || 'unknown'}
Visual Engagement: ${currentInsights.presentation_quality?.visual_engagement || 0}/100
Key Strengths: ${coaching.communication_strengths?.join(', ') || 'none identified'}
Growth Areas: ${coaching.growth_opportunities?.join(', ') || 'none identified'}

Top Recommendations:
${recommendations.slice(0, 3).map(r => `- ${r.category}: ${r.suggestion}`).join('\n')}

Provide personalized, encouraging, and actionable coaching advice. Reference their specific archetype and development stage. Be conversational and supportive.`;

            // Call OpenAI API (configure your API key)
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'gpt-4',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userMessage }
                    ],
                    max_tokens: 500,
                    temperature: 0.7
                })
            });

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function displayTranscriptResults(insights) {
            // Display speech quality metrics
            const metrics = insights.speech_metrics || {};
            
            document.getElementById('speechQuality').textContent = `${Math.round(metrics.overall_quality || 0)}/100`;
            document.getElementById('speechQualityBar').style.width = `${metrics.overall_quality || 0}%`;
            
            document.getElementById('speakingPace').textContent = `${metrics.speaking_pace || 0} WPM`;
            document.getElementById('speakingPaceBar').style.width = `${Math.min((metrics.speaking_pace || 0) / 200 * 100, 100)}%`;
            
            document.getElementById('toneVariety').textContent = `${Math.round(metrics.tone_variety || 0)}/100`;
            document.getElementById('toneVarietyBar').style.width = `${metrics.tone_variety || 0}%`;
            
            document.getElementById('clarityScore').textContent = `${Math.round(metrics.clarity_score || 0)}/100`;
            document.getElementById('clarityScoreBar').style.width = `${metrics.clarity_score || 0}%`;
            
            // Display speech patterns
            const patterns = insights.speech_patterns || {};
            document.getElementById('fillerWords').textContent = `${patterns.filler_count || 0} occurrences`;
            document.getElementById('pausePattern').textContent = patterns.pause_analysis || 'Well-paced';
            document.getElementById('repetitions').textContent = `${patterns.repetition_count || 0} instances`;
            
            // Display content structure
            const structure = insights.content_structure || {};
            document.getElementById('transitions').textContent = structure.transition_quality || 'Good';
            document.getElementById('keyPoints').textContent = `${structure.key_points_count || 0} identified`;
            document.getElementById('conclusion').textContent = structure.conclusion_strength || 'Strong';
            
            // Display speech recommendations
            const recommendations = insights.recommendations || [];
            const speechRecsHtml = recommendations.map(rec => `
                <div class="recommendation-card rec-priority-${rec.priority || 'medium'}">
                    <div class="rec-category">${rec.category || 'Speech'}</div>
                    <div class="rec-suggestion">${rec.suggestion || 'No suggestion available'}</div>
                    <div style="font-size: 0.9em; color: #666;">
                        <strong>Impact:</strong> ${rec.score_impact || 'Positive improvement'}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('speechRecommendations').innerHTML = speechRecsHtml;
        }

        function displayCombinedResults(combinedInsights) {
            const videoScore = combinedInsights.video?.presentation_quality?.overall_score || 0;
            const speechScore = combinedInsights.transcript?.speech_metrics?.overall_quality || 0;
            const overallScore = combinedInsights.combined_score || Math.round((videoScore + speechScore) / 2);
            
            document.getElementById('combinedVisual').textContent = `${Math.round(videoScore)}/100`;
            document.getElementById('combinedSpeech').textContent = `${Math.round(speechScore)}/100`;
            document.getElementById('combinedOverall').textContent = `${Math.round(overallScore)}/100`;
        }

        function calculateCombinedScore(videoInsights, transcriptInsights) {
            const videoScore = videoInsights?.presentation_quality?.overall_score || 0;
            const speechScore = transcriptInsights?.speech_metrics?.overall_quality || 0;
            return Math.round((videoScore + speechScore) / 2);
        }

        function displayDemoTranscriptResults() {
            const demoTranscriptInsights = {
                speech_metrics: {
                    overall_quality: 78,
                    speaking_pace: 145,
                    tone_variety: 72,
                    clarity_score: 85
                },
                speech_patterns: {
                    filler_count: 8,
                    pause_analysis: 'Well-paced with strategic pauses',
                    repetition_count: 3
                },
                content_structure: {
                    transition_quality: 'Excellent',
                    key_points_count: 5,
                    conclusion_strength: 'Strong and memorable'
                },
                recommendations: [
                    {
                        category: 'Pacing',
                        suggestion: 'Consider slowing down slightly during complex explanations',
                        priority: 'medium',
                        score_impact: '+5 points in clarity'
                    },
                    {
                        category: 'Filler Words',
                        suggestion: 'Practice pausing instead of using "um" and "like"',
                        priority: 'low',
                        score_impact: '+3 points in professionalism'
                    }
                ]
            };
            
            displayTranscriptResults(demoTranscriptInsights);
            document.getElementById('transcriptResults').style.display = 'block';
        }

        // Demo function for testing
        function displayDemoResults() {
            const demoInsights = {
                coaching_insights: {
                    speaker_archetype: 'confident_professional',
                    development_stage: 'intermediate',
                    communication_strengths: [
                        'Exceptional eye contact builds strong audience connection',
                        'Positive emotional tone creates engaging atmosphere',
                        'Maintains consistent professional energy throughout'
                    ],
                    growth_opportunities: [
                        'Increase natural smile frequency to enhance approachability',
                        'Add more dynamic gestures for emphasis',
                        'Vary emotional expression to match content tone'
                    ]
                },
                presentation_quality: {
                    visual_engagement: 87,
                    body_language: {
                        eye_contact_rating: 82
                    }
                },
                facial_analysis: {
                    faces_detected: 1,
                    facial_expressions: {
                        smile_percentage: 35.2
                    },
                    emotion_timeline: [
                        { timestamp: '00:00:10', emotion: 'neutral', confidence: 0.8 },
                        { timestamp: '00:02:30', emotion: 'confidence', confidence: 0.95 },
                        { timestamp: '00:05:15', emotion: 'joy', confidence: 0.85 }
                    ]
                },
                visual_sentiment: {
                    emotional_patterns: {
                        opening_confidence: 0.8,
                        mid_presentation_energy: 0.9,
                        closing_impact: 0.88,
                        emotional_arc: 'consistently_strong'
                    }
                },
                recommendations: [
                    {
                        category: 'excellence',
                        suggestion: 'Outstanding visual engagement! You demonstrate strong professional presence and confidence.',
                        priority: 'celebration',
                        score_impact: 'Maintain this excellence',
                        next_steps: ['Record yourself for self-analysis', 'Seek speaking opportunities', 'Develop signature style']
                    },
                    {
                        category: 'expression_variety',
                        suggestion: 'Your confidence shines through consistently. Experiment with more varied facial expressions that match your content\'s emotional tone.',
                        priority: 'medium',
                        score_impact: 'Could elevate score to 90+',
                        next_steps: ['Practice with mirror', 'Map emotions to content', 'Record practice sessions']
                    }
                ]
            };
            
            currentInsights = demoInsights;
            displayResults(demoInsights);
        }
    </script>
</body>
</html>
